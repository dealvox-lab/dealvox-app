<div class="card" id="voicesCard">
  <h2>Voices</h2>
  <p>
    Pick a default voice for your assistant. Your choice will be saved in your
    assistant settings and used for all calls made from this account.
  </p>

  <p id="voiceStatus" class="status-text"></p>

  <div id="voicesGrid" class="voices-grid">
    <!-- Voice cards will be injected here -->
  </div>
</div>

<script>
  // ---------- Static voices list (generated from your CSV) ----------
  const DEALVOX_VOICES = [
    {
      "voice_id": "voice_alex",
      "name": "Alex",
      "accent": "US",
      "gender": "Male",
      "age": "30s",
      "avatar": "https://storage.googleapis.com/dealvox-public/voices/avatars/alex.png",
      "preview": "https://storage.googleapis.com/dealvox-public/voices/previews/alex.mp3"
    },
    {
      "voice_id": "voice_sophia",
      "name": "Sophia",
      "accent": "US",
      "gender": "Female",
      "age": "30s",
      "avatar": "https://storage.googleapis.com/dealvox-public/voices/avatars/sophia.png",
      "preview": "https://storage.googleapis.com/dealvox-public/voices/previews/sophia.mp3"
    },
    {
      "voice_id": "voice_emma",
      "name": "Emma",
      "accent": "UK",
      "gender": "Female",
      "age": "20s",
      "avatar": "https://storage.googleapis.com/dealvox-public/voices/avatars/emma.png",
      "preview": "https://storage.googleapis.com/dealvox-public/voices/previews/emma.mp3"
    },
    {
      "voice_id": "voice_liam",
      "name": "Liam",
      "accent": "US",
      "gender": "Male",
      "age": "20s",
      "avatar": "https://storage.googleapis.com/dealvox-public/voices/avatars/liam.png",
      "preview": "https://storage.googleapis.com/dealvox-public/voices/previews/liam.mp3"
    },
    {
      "voice_id": "voice_olivia",
      "name": "Olivia",
      "accent": "US",
      "gender": "Female",
      "age": "20s",
      "avatar": "https://storage.googleapis.com/dealvox-public/voices/avatars/olivia.png",
      "preview": "https://storage.googleapis.com/dealvox-public/voices/previews/olivia.mp3"
    },
    {
      "voice_id": "voice_noah",
      "name": "Noah",
      "accent": "UK",
      "gender": "Male",
      "age": "30s",
      "avatar": "https://storage.googleapis.com/dealvox-public/voices/avatars/noah.png",
      "preview": "https://storage.googleapis.com/dealvox-public/voices/previews/noah.mp3"
    },
    {
      "voice_id": "voice_ava",
      "name": "Ava",
      "accent": "US",
      "gender": "Female",
      "age": "40s",
      "avatar": "https://storage.googleapis.com/dealvox-public/voices/avatars/ava.png",
      "preview": "https://storage.googleapis.com/dealvox-public/voices/previews/ava.mp3"
    },
    {
      "voice_id": "voice_william",
      "name": "William",
      "accent": "US",
      "gender": "Male",
      "age": "40s",
      "avatar": "https://storage.googleapis.com/dealvox-public/voices/avatars/william.png",
      "preview": "https://storage.googleapis.com/dealvox-public/voices/previews/william.mp3"
    },
    {
      "voice_id": "voice_isabella",
      "name": "Isabella",
      "accent": "US",
      "gender": "Female",
      "age": "30s",
      "avatar": "https://storage.googleapis.com/dealvox-public/voices/avatars/isabella.png",
      "preview": "https://storage.googleapis.com/dealvox-public/voices/previews/isabella.mp3"
    },
    {
      "voice_id": "voice_james",
      "name": "James",
      "accent": "US",
      "gender": "Male",
      "age": "50s",
      "avatar": "https://storage.googleapis.com/dealvox-public/voices/avatars/james.png",
      "preview": "https://storage.googleapis.com/dealvox-public/voices/previews/james.mp3"
    },
    {
      "voice_id": "voice_mia",
      "name": "Mia",
      "accent": "US",
      "gender": "Female",
      "age": "20s",
      "avatar": "https://storage.googleapis.com/dealvox-public/voices/avatars/mia.png",
      "preview": "https://storage.googleapis.com/dealvox-public/voices/previews/Mia.mp3"
    },
    {
      "voice_id": "voice_benjamin",
      "name": "Benjamin",
      "accent": "US",
      "gender": "Male",
      "age": "30s",
      "avatar": "https://storage.googleapis.com/dealvox-public/voices/avatars/benjamin.png",
      "preview": "https://storage.googleapis.com/dealvox-public/voices/previews/benjamin.mp3"
    },
    {
      "voice_id": "voice_charlotte",
      "name": "Charlotte",
      "accent": "US",
      "gender": "Female",
      "age": "30s",
      "avatar": "https://storage.googleapis.com/dealvox-public/voices/avatars/charlotte.png",
      "preview": "https://storage.googleapis.com/dealvox-public/voices/previews/charlotte.mp3"
    },
    {
      "voice_id": "voice_elijah",
      "name": "Elijah",
      "accent": "US",
      "gender": "Male",
      "age": "30s",
      "avatar": "https://storage.googleapis.com/dealvox-public/voices/avatars/elijah.png",
      "preview": "https://storage.googleapis.com/dealvox-public/voices/previews/elijah.mp3"
    },
    {
      "voice_id": "voice_amelia",
      "name": "Amelia",
      "accent": "US",
      "gender": "Female",
      "age": "20s",
      "avatar": "https://storage.googleapis.com/dealvox-public/voices/avatars/amelia.png",
      "preview": "https://storage.googleapis.com/dealvox-public/voices/previews/amelia.mp3"
    },
    {
      "voice_id": "voice_logan",
      "name": "Logan",
      "accent": "US",
      "gender": "Male",
      "age": "40s",
      "avatar": "https://storage.googleapis.com/dealvox-public/voices/avatars/logan.png",
      "preview": "https://storage.googleapis.com/dealvox-public/voices/previews/logan.mp3"
    },
    {
      "voice_id": "voice_lily",
      "name": "Lily",
      "accent": "US",
      "gender": "Female",
      "age": "20s",
      "avatar": "https://storage.googleapis.com/dealvox-public/voices/avatars/lily.png",
      "preview": "https://storage.googleapis.com/dealvox-public/voices/previews/lily.mp3"
    },
    {
      "voice_id": "voice_lucas",
      "name": "Lucas",
      "accent": "US",
      "gender": "Male",
      "age": "20s",
      "avatar": "https://storage.googleapis.com/dealvox-public/voices/avatars/lucas.png",
      "preview": "https://storage.googleapis.com/dealvox-public/voices/previews/lucas.mp3"
    },
    {
      "voice_id": "voice_grace",
      "name": "Grace",
      "accent": "US",
      "gender": "Female",
      "age": "40s",
      "avatar": "https://storage.googleapis.com/dealvox-public/voices/avatars/grace.png",
      "preview": "https://storage.googleapis.com/dealvox-public/voices/previews/grace.mp3"
    },
    {
      "voice_id": "voice_mason",
      "name": "Mason",
      "accent": "US",
      "gender": "Male",
      "age": "20s",
      "avatar": "https://storage.googleapis.com/dealvox-public/voices/avatars/mason.png",
      "preview": "https://storage.googleapis.com/dealvox-public/voices/previews/mason.mp3"
    },
    {
      "voice_id": "voice_chloe",
      "name": "Chloe",
      "accent": "US",
      "gender": "Female",
      "age": "20s",
      "avatar": "https://storage.googleapis.com/dealvox-public/voices/avatars/chloe.png",
      "preview": "https://storage.googleapis.com/dealvox-public/voices/previews/chloe.mp3"
    },
    {
      "voice_id": "voice_henry",
      "name": "Henry",
      "accent": "US",
      "gender": "Male",
      "age": "30s",
      "avatar": "https://storage.googleapis.com/dealvox-public/voices/avatars/henry.png",
      "preview": "https://storage.googleapis.com/dealvox-public/voices/previews/henry.mp3"
    },
    {
      "voice_id": "voice_zoe",
      "name": "Zoe",
      "accent": "US",
      "gender": "Female",
      "age": "20s",
      "avatar": "https://storage.googleapis.com/dealvox-public/voices/avatars/zoe.png",
      "preview": "https://storage.googleapis.com/dealvox-public/voices/previews/zoe.mp3"
    },
    {
      "voice_id": "voice_jackson",
      "name": "Jackson",
      "accent": "US",
      "gender": "Male",
      "age": "30s",
      "avatar": "https://storage.googleapis.com/dealvox-public/voices/avatars/jackson.png",
      "preview": "https://storage.googleapis.com/dealvox-public/voices/previews/jackson.mp3"
    },
    {
      "voice_id": "voice_ella",
      "name": "Ella",
      "accent": "US",
      "gender": "Female",
      "age": "30s",
      "avatar": "https://storage.googleapis.com/dealvox-public/voices/avatars/ella.png",
      "preview": "https://storage.googleapis.com/dealvox-public/voices/previews/ella.mp3"
    },
    {
      "voice_id": "voice_levi",
      "name": "Levi",
      "accent": "US",
      "gender": "Male",
      "age": "30s",
      "avatar": "https://storage.googleapis.com/dealvox-public/voices/avatars/levi.png",
      "preview": "https://storage.googleapis.com/dealvox-public/voices/previews/levi.mp3"
    },
    {
      "voice_id": "voice_nora",
      "name": "Nora",
      "accent": "US",
      "gender": "Female",
      "age": "30s",
      "avatar": "https://storage.googleapis.com/dealvox-public/voices/avatars/nora.png",
      "preview": "https://storage.googleapis.com/dealvox-public/voices/previews/nora.mp3"
    },
    {
      "voice_id": "voice_owen",
      "name": "Owen",
      "accent": "US",
      "gender": "Male",
      "age": "20s",
      "avatar": "https://storage.googleapis.com/dealvox-public/voices/avatars/owen.png",
      "preview": "https://storage.googleapis.com/dealvox-public/voices/previews/owen.mp3"
    },
    {
      "voice_id": "voice_hannah",
      "name": "Hannah",
      "accent": "US",
      "gender": "Female",
      "age": "40s",
      "avatar": "https://storage.googleapis.com/dealvox-public/voices/avatars/hannah.png",
      "preview": "https://storage.googleapis.com/dealvox-public/voices/previews/hannah.mp3"
    },
    {
      "voice_id": "voice_wyatt",
      "name": "Wyatt",
      "accent": "US",
      "gender": "Male",
      "age": "40s",
      "avatar": "https://storage.googleapis.com/dealvox-public/voices/avatars/wyatt.png",
      "preview": "https://storage.googleapis.com/dealvox-public/voices/previews/wyatt.mp3"
    },
    {
      "voice_id": "voice_riley",
      "name": "Riley",
      "accent": "US",
      "gender": "Female",
      "age": "20s",
      "avatar": "https://storage.googleapis.com/dealvox-public/voices/avatars/riley.png",
      "preview": "https://storage.googleapis.com/dealvox-public/voices/previews/riley.mp3"
    },
    {
      "voice_id": "voice_sebastian",
      "name": "Sebastian",
      "accent": "US",
      "gender": "Male",
      "age": "30s",
      "avatar": "https://storage.googleapis.com/dealvox-public/voices/avatars/sebastian.png",
      "preview": "https://storage.googleapis.com/dealvox-public/voices/previews/sebastian.mp3"
    }
  ];

  // ------------- Voices init + Supabase integration -------------
  async function initVoicesView() {
    const grid   = document.getElementById("voicesGrid");
    const status = document.getElementById("voiceStatus");
    if (!grid) return;

    let auth;
    try {
      auth = await getAuthInfo();
    } catch (err) {
      console.error("getAuthInfo (voices) failed:", err);
      if (status) status.textContent = "Unable to load voices (auth failed).";
      return;
    }

    if (!auth.user || !auth.accessToken) {
      if (status) status.textContent = "Session expired. Please log in again.";
      return;
    }

    const user = auth.user;
    let selectedVoiceId = null;

    // --- Load current assistant voice from Supabase ---
    async function loadAssistantVoice() {
      const baseUrl = `${window.SUPABASE_URL.replace(/\/+$/, "")}/rest/v1/assistants`;
      const params = new URLSearchParams();
      params.set("select", "id,agent_voice");
      params.set("user_id", `eq.${user.id}`);
      params.set("limit", "1");

      try {
        const res = await fetch(`${baseUrl}?${params.toString()}`, {
          headers: supabaseHeaders(auth.accessToken),
        });
        if (!res.ok) {
          console.warn("loadAssistantVoice error:", res.status, await res.text());
          return;
        }
        const rows = await res.json();
        if (rows && rows[0]) {
          selectedVoiceId = rows[0].agent_voice || null;
        }
      } catch (err) {
        console.error("loadAssistantVoice exception:", err);
      }
    }

    // --- Save selected voice (assistant.agent_voice) ---
    async function saveVoice(voiceId) {
      const baseUrl = `${window.SUPABASE_URL.replace(/\/+$/, "")}/rest/v1/assistants`;

      const payload = {
        user_id: user.id,
        agent_voice: voiceId
      };

      const res = await fetch(baseUrl, {
        method: "POST",
        headers: {
          ...supabaseHeaders(auth.accessToken),
          Prefer: "return=minimal, resolution=merge-duplicates",
        },
        body: JSON.stringify(payload),
      });

      if (!res.ok) {
        const text = await res.text();
        throw new Error(`Save voice failed: ${res.status} ${text}`);
      }
    }

    function flashSaved(el) {
      if (!el) return;
      el.classList.add("visible");
      setTimeout(() => el.classList.remove("visible"), 1400);
    }

    // --- Render cards ---
    function renderVoices() {
      grid.innerHTML = "";

      DEALVOX_VOICES.forEach((v) => {
        const card = document.createElement("div");
        card.className = "voice-card" + (v.voice_id === selectedVoiceId ? " selected" : "");

        card.innerHTML = `
          <div class="voice-avatar">
            <img src="${v.avatar}" alt="${v.name} avatar" loading="lazy" />
          </div>
          <div class="voice-main">
            <div class="voice-header-row">
              <h3 class="voice-name">${v.name}</h3>
              <span class="voice-tag">${v.accent}</span>
              <span class="voice-tag">${v.gender}</span>
              <span class="voice-tag">${v.age}</span>
            </div>
            <div class="voice-actions">
              <button class="btn-secondary small" data-role="preview">▶ Preview</button>
              <button class="btn-primary small" data-role="select">
                ${v.voice_id === selectedVoiceId ? "Selected" : "Select this voice"}
              </button>
              <span class="copy-status" data-role="saved-label">Saved</span>
            </div>
          </div>
          <audio src="${v.preview}" preload="none"></audio>
        `;

        grid.appendChild(card);

        const audio       = card.querySelector("audio");
        const previewBtn  = card.querySelector('[data-role="preview"]');
        const selectBtn   = card.querySelector('[data-role="select"]');
        const savedLabel  = card.querySelector('[data-role="saved-label"]');

        previewBtn.addEventListener("click", () => {
          // stop others
          document.querySelectorAll("#voicesGrid audio").forEach((a) => {
            if (a !== audio) {
              a.pause();
              a.currentTime = 0;
            }
          });

          if (audio.paused) {
            audio.play();
          } else {
            audio.pause();
            audio.currentTime = 0;
          }
        });

        selectBtn.addEventListener("click", async () => {
          if (v.voice_id === selectedVoiceId) return;

          selectBtn.disabled = true;
          if (status) status.textContent = "Saving voice selection…";

          try {
            await saveVoice(v.voice_id);
            selectedVoiceId = v.voice_id;

            // update selected styles
            document
              .querySelectorAll(".voice-card")
              .forEach((c) => c.classList.remove("selected"));
            card.classList.add("selected");

            // update all buttons text
            document
              .querySelectorAll(".voice-card button[data-role='select']")
              .forEach((b) => (b.textContent = "Select this voice"));
            selectBtn.textContent = "Selected";

            flashSaved(savedLabel);
            if (status) status.textContent = "Voice updated.";
          } catch (err) {
            console.error(err);
            if (status) status.textContent = "Could not save voice. Try again.";
          } finally {
            selectBtn.disabled = false;
          }
        });
      });
    }

    await loadAssistantVoice();
    renderVoices();
  }

  // If your SPA explicitly calls initVoicesView from account.js,
  // this will simply define the function. As a fallback we auto-run once.
  if (!window.__voicesViewBound) {
    window.__voicesViewBound = true;
    initVoicesView();
  }
</script>
