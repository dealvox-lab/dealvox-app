// /assets/js/account-voices.js

// Static catalog generated from your CSV
const VOICES = [
 {
   "id": "11labs-Billy",
   "name": "Billy",
   "accent": "American",
   "gender": "male",
   "age": "young",
   "avatar": "https://retell-utils-public.s3.us-west-2.amazonaws.com/billy.png",
   "preview": "https://retell-utils-public.s3.us-west-2.amazonaws.com/billy.mp3"
 },
 {
   "id": "11labs-Lily",
   "name": "Lily",
   "accent": "American",
   "gender": "female",
   "age": "young",
   "avatar": "https://retell-utils-public.s3.us-west-2.amazonaws.com/lily.png",
   "preview": "https://retell-utils-public.s3.us-west-2.amazonaws.com/lily.mp3"
 },
 {
   "id": "11labs-Marissa",
   "name": "Marissa",
   "accent": "American",
   "gender": "female",
   "age": "young",
   "avatar": "https://retell-utils-public.s3.us-west-2.amazonaws.com/Marissa.png",
   "preview": "https://retell-utils-public.s3.us-west-2.amazonaws.com/marissa.mp3"
 },
 {
   "id": "11labs-Bing",
   "name": "Bing",
   "accent": "American",
   "gender": "male",
   "age": "young",
   "avatar": "https://retell-utils-public.s3.us-west-2.amazonaws.com/bing.png",
   "preview": "https://retell-utils-public.s3.us-west-2.amazonaws.com/bing.mp3"
 },
 {
   "id": "11labs-Jenny",
   "name": "Jenny",
   "accent": "American",
   "gender": "female",
   "age": "young",
   "avatar": "https://retell-utils-public.s3.us-west-2.amazonaws.com/Jenny.png",
   "preview": "https://retell-utils-public.s3.us-west-2.amazonaws.com/Jenny.mp3"
 },
 {
   "id": "11labs-Lucas",
   "name": "Lucas",
   "accent": "American",
   "gender": "male",
   "age": "middle-aged",
   "avatar": "https://retell-utils-public.s3.us-west-2.amazonaws.com/lucas.png",
   "preview": "https://retell-utils-public.s3.us-west-2.amazonaws.com/lucas.mp3"
 },
 {
   "id": "11labs-Brian",
   "name": "Brian",
   "accent": "American",
   "gender": "male",
   "age": "young",
   "avatar": "https://retell-utils-public.s3.us-west-2.amazonaws.com/brian.png",
   "preview": "https://retell-utils-public.s3.us-west-2.amazonaws.com/brian.mp3"
 },
 {
   "id": "11labs-Kate",
   "name": "Kate",
   "accent": "American",
   "gender": "female",
   "age": "middle-aged",
   "avatar": "https://retell-utils-public.s3.us-west-2.amazonaws.com/Kate.png",
   "preview": "https://retell-utils-public.s3.us-west-2.amazonaws.com/kate.mp3"
 },
 {
   "id": "11labs-Jason",
   "name": "Jason",
   "accent": "American",
   "gender": "male",
   "age": "young",
   "avatar": "https://retell-utils-public.s3.us-west-2.amazonaws.com/Jason.png",
   "preview": "https://retell-utils-public.s3.us-west-2.amazonaws.com/jason.mp3"
 },
 {
   "id": "11labs-Ethan",
   "name": "Ethan",
   "accent": "American",
   "gender": "male",
   "age": "young",
   "avatar": "https://retell-utils-public.s3.us-west-2.amazonaws.com/ethan.png",
   "preview": "https://retell-utils-public.s3.us-west-2.amazonaws.com/ethan.mp3"
 },
 {
   "id": "11labs-Paul",
   "name": "Paul",
   "accent": "American",
   "gender": "male",
   "age": "old",
   "avatar": "https://retell-utils-public.s3.us-west-2.amazonaws.com/paul.png",
   "preview": "https://retell-utils-public.s3.us-west-2.amazonaws.com/paul.mp3"
 },
 {
   "id": "11labs-John",
   "name": "John",
   "accent": "American",
   "gender": "male",
   "age": "middle-aged",
   "avatar": "https://retell-utils-public.s3.us-west-2.amazonaws.com/John.png",
   "preview": "https://retell-utils-public.s3.us-west-2.amazonaws.com/John.mp3"
 },
 {
   "id": "11labs-Adrian",
   "name": "Adrian",
   "accent": "American",
   "gender": "male",
   "age": "young",
   "avatar": "https://retell-utils-public.s3.us-west-2.amazonaws.com/adrian.png",
   "preview": "https://retell-utils-public.s3.us-west-2.amazonaws.com/adrian.mp3"
 },
 {
   "id": "11labs-Gilfoy",
   "name": "Gilfoy",
   "accent": "American",
   "gender": "male",
   "age": "middle-aged",
   "avatar": "https://retell-utils-public.s3.us-west-2.amazonaws.com/gilfoy.png",
   "preview": "https://retell-utils-public.s3.us-west-2.amazonaws.com/gilfoy.mp3"
 },
 {
   "id": "11labs-Zuri",
   "name": "Zuri",
   "accent": "American",
   "gender": "female",
   "age": "old",
   "avatar": "https://retell-utils-public.s3.us-west-2.amazonaws.com/Zuri.png",
   "preview": "https://retell-utils-public.s3.us-west-2.amazonaws.com/zuri.mp3"
 },
 {
   "id": "11labs-Steve",
   "name": "Steve",
   "accent": "American",
   "gender": "male",
   "age": "old",
   "avatar": "https://retell-utils-public.s3.us-west-2.amazonaws.com/Steve.png",
   "preview": "https://retell-utils-public.s3.us-west-2.amazonaws.com/Steve-.mp3"
 },
 {
   "id": "11labs-Grace",
   "name": "Grace",
   "accent": "American",
   "gender": "female",
   "age": "middle-aged",
   "avatar": "https://retell-utils-public.s3.us-west-2.amazonaws.com/grace.png",
   "preview": "https://retell-utils-public.s3.us-west-2.amazonaws.com/grace.mp3"
 },
 {
   "id": "11labs-Chloe",
   "name": "Chloe",
   "accent": "American",
   "gender": "female",
   "age": "young",
   "avatar": "https://retell-utils-public.s3.us-west-2.amazonaws.com/Chloe.png",
   "preview": "https://retell-utils-public.s3.us-west-2.amazonaws.com/chloe.mp3"
 },
 {
   "id": "11labs-Max",
   "name": "Max",
   "accent": "American",
   "gender": "male",
   "age": "middle-aged",
   "avatar": "https://retell-utils-public.s3.us-west-2.amazonaws.com/max.png",
   "preview": "https://retell-utils-public.s3.us-west-2.amazonaws.com/Max.mp3"
 },
 {
   "id": "11labs-Anna",
   "name": "Anna",
   "accent": "American",
   "gender": "female",
   "age": "young",
   "avatar": "https://retell-utils-public.s3.us-west-2.amazonaws.com/anna.png",
   "preview": "https://retell-utils-public.s3.us-west-2.amazonaws.com/anna.mp3"
 },
 {
   "id": "11labs-Julia",
   "name": "Julia",
   "accent": "American",
   "gender": "female",
   "age": "middle-aged",
   "avatar": "https://retell-utils-public.s3.us-west-2.amazonaws.com/Julia.png",
   "preview": "https://retell-utils-public.s3.us-west-2.amazonaws.com/julia.mp3"
 },
 {
   "id": "11labs-victoria",
   "name": "Victoria",
   "accent": "American",
   "gender": "female",
   "age": "young",
   "avatar": "https://retell-utils-public.s3.us-west-2.amazonaws.com/Victoria.png",
   "preview": "https://retell-utils-public.s3.us-west-2.amazonaws.com/Victoria.mp3"
 },
 {
   "id": "11labs-Susan",
   "name": "Susan",
   "accent": "American",
   "gender": "female",
   "age": "middle-aged",
   "avatar": "https://retell-utils-public.s3.us-west-2.amazonaws.com/Susan.png",
   "preview": "https://retell-utils-public.s3.us-west-2.amazonaws.com/susan.mp3"
 },
 {
   "id": "11labs-Emily",
   "name": "Emily",
   "accent": "American",
   "gender": "female",
   "age": "middle-aged",
   "avatar": "https://retell-utils-public.s3.us-west-2.amazonaws.com/emily.png",
   "preview": "https://retell-utils-public.s3.us-west-2.amazonaws.com/custom_voice_ad3caa44911a95fb08b2526918.mp3"
 },
 {
   "id": "11labs-Kathrine",
   "name": "Kathrine",
   "accent": "American",
   "gender": "female",
   "age": "middle-aged",
   "avatar": "https://retell-utils-public.s3.us-west-2.amazonaws.com/kathrine.png",
   "preview": "https://retell-utils-public.s3.us-west-2.amazonaws.com/Kathrine.mp3"
 },
 {
   "id": "11labs-Andrew",
   "name": "Andrew",
   "accent": "American",
   "gender": "male",
   "age": "young",
   "avatar": "https://retell-utils-public.s3.us-west-2.amazonaws.com/andrew.png",
   "preview": "https://retell-utils-public.s3.us-west-2.amazonaws.com/andrew.mp3"
 },
 {
   "id": "11labs-Nina",
   "name": "Nina",
   "accent": "American",
   "gender": "female",
   "age": "middle-aged",
   "avatar": "https://retell-utils-public.s3.us-west-2.amazonaws.com/nina.png",
   "preview": "https://retell-utils-public.s3.us-west-2.amazonaws.com/nina.mp3"
 },
 {
   "id": "11labs-Myra",
   "name": "Myra",
   "accent": "American",
   "gender": "female",
   "age": "young",
   "avatar": "https://retell-utils-public.s3.us-west-2.amazonaws.com/Myra.png",
   "preview": "https://retell-utils-public.s3.us-west-2.amazonaws.com/myra.mp3"
 },
 {
   "id": "11labs-Evie",
   "name": "Evie",
   "accent": "American",
   "gender": "female",
   "age": "young",
   "avatar": "https://retell-utils-public.s3.us-west-2.amazonaws.com/evie.png",
   "preview": "https://retell-utils-public.s3.us-west-2.amazonaws.com/evie.mp3"
 },
 {
   "id": "11labs-James",
   "name": "James",
   "accent": "American",
   "gender": "male",
   "age": "old",
   "avatar": "https://retell-utils-public.s3.us-west-2.amazonaws.com/james.png",
   "preview": "https://retell-utils-public.s3.us-west-2.amazonaws.com/James.mp3"
 },
 {
   "id": "11labs-Cimo",
   "name": "Cimo",
   "accent": "American",
   "gender": "female",
   "age": "middle-aged",
   "avatar": "https://retell-utils-public.s3.us-west-2.amazonaws.com/cimo.png",
   "preview": "https://retell-utils-public.s3.us-west-2.amazonaws.com/cimo.mp3"
 },
 {
   "id": "11labs-Ryan",
   "name": "Ryan",
   "accent": "American",
   "gender": "male",
   "age": "young",
   "avatar": "https://retell-utils-public.s3.us-west-2.amazonaws.com/ryan.png",
   "preview": "https://retell-utils-public.s3.us-west-2.amazonaws.com/ryan.mp3"
 },
 {
   "id": "11labs-Mia",
   "name": "Mia",
   "accent": "American",
   "gender": "female",
   "age": "middle-aged",
   "avatar": "https://retell-utils-public.s3.us-west-2.amazonaws.com/mia.png",
   "preview": "https://retell-utils-public.s3.us-west-2.amazonaws.com/Mia.mp3"
 }
];

// ----------------------------------------------------
// Voices tab logic (uses helpers from account.js)
// ----------------------------------------------------

window.initVoicesView = async function initVoicesView() {
  const grid     = document.getElementById("voicesGrid");
  const statusEl = document.getElementById("voicesStatus");
  const audioEl  = document.getElementById("voicePreviewAudio");

  if (!grid) return;

  grid.innerHTML = "";
  if (statusEl) statusEl.textContent = "Loading voices…";

  // 1) Auth info from existing helpers
  let auth;
  try {
    auth = await getAuthInfo();
  } catch (err) {
    console.error("getAuthInfo failed (voices):", err);
    if (statusEl) statusEl.textContent = "Unable to load voices. Please reload.";
    return;
  }

  if (!auth.user || !auth.accessToken) {
    if (statusEl) statusEl.textContent = "Session expired. Please log in again.";
    return;
  }

  const userId  = auth.user.id;
  const baseUrl = `${window.SUPABASE_URL.replace(/\/+$/, "")}/rest/v1/assistants`;

  function setStatus(msg, isError = false) {
    if (!statusEl) return;
    statusEl.textContent = msg || "";
    statusEl.classList.toggle("error", !!isError);
  }

  // 2) Load current voice + deployment state (assistants.agent_voice, assistants.is_published)
  let currentVoiceId      = null;
  let assistantIsDeployed = false;   // <- controls Select button state

  async function loadCurrentVoice() {
    const params = new URLSearchParams();
    params.set("select", "agent_voice,is_published");
    params.set("user_id", `eq.${userId}`);
    params.set("limit", "1");

    async function run(currentAuth) {
      return fetch(`${baseUrl}?${params.toString()}`, {
        headers: supabaseHeaders(currentAuth.accessToken),
      });
    }

    let res = await run(auth);
    if (res.status === 401) {
      const newAuth = await handleJwt401(res, "load voice");
      if (!newAuth) {
        setStatus("Session expired. Please log in again.", true);
        return;
      }
      auth = newAuth;
      res  = await run(auth);
    }

    if (!res.ok) {
      console.warn("loadCurrentVoice HTTP error", res.status, await res.text());
      return;
    }

    const rows = await res.json();
    const row  = rows && rows[0];

    if (row) {
      if (row.agent_voice) currentVoiceId = row.agent_voice;
      // Treat is_published as "deployed"
      assistantIsDeployed = !!row.is_published;
    } else {
      currentVoiceId      = null;
      assistantIsDeployed = false;
    }
  }

  // 3) Render voices grid
  function renderVoices() {
    grid.innerHTML = "";
    VOICES.forEach((voice) => {
      const card = document.createElement("div");
      card.className = "voice-card";
      card.dataset.voiceId = voice.id;

      if (currentVoiceId && voice.id === currentVoiceId) {
        card.classList.add("selected");
      }

      card.innerHTML = `
        <div class="voice-avatar-wrapper">
          <img class="voice-avatar" src="${voice.avatar}" alt="${voice.name}" loading="lazy" />
        </div>
        <div class="voice-body">
          <h3 class="voice-name">${voice.name}</h3>
          <p class="voice-meta">
            ${voice.gender ? voice.gender : ""}${
              voice.gender && voice.accent ? " · " : ""
            }${voice.accent ? voice.accent : ""}${
              (voice.gender || voice.accent) && voice.age ? " · " : ""
            }${voice.age ? voice.age : ""}
          </p>
          <div class="voice-actions">
            <button
              type="button"
              class="btn-secondary small voice-preview-btn"
              data-role="preview-voice"
              data-preview-url="${voice.preview}"
              data-voice-id="${voice.id}"
            >
              ▶ Listen
            </button>
            <button
              type="button"
              class="btn-primary small voice-select-btn
                ${assistantIsDeployed ? "" : "disabled"}"
              data-role="select-voice"
              data-voice-id="${voice.id}"
              title="${
                assistantIsDeployed
                  ? "Use this voice for your assistant."
                  : "Deploy an assistant first."
              }"
              ${assistantIsDeployed ? "" : "disabled"}
            >
              Select this voice
            </button>
          </div>
        </div>
      `;
      grid.appendChild(card);
    });
  }

  function markSelected(voiceId) {
    const cards = grid.querySelectorAll(".voice-card");
    cards.forEach((card) => {
      card.classList.toggle("selected", card.dataset.voiceId === voiceId);
    });
  }

  // 4) Save selected voice into assistants.agent_voice
  async function saveVoice(voiceId) {
    setStatus("Saving voice…");

    const payload = {
      user_id:     userId,
      agent_voice: voiceId,
    };

    async function run(currentAuth) {
      return fetch(baseUrl, {
        method: "POST",
        headers: {
          ...supabaseHeaders(currentAuth.accessToken),
          Prefer: "return=minimal, resolution=merge-duplicates",
        },
        body: JSON.stringify(payload),
      });
    }

    let res = await run(auth);
    if (res.status === 401) {
      const newAuth = await handleJwt401(res, "save voice");
      if (!newAuth) {
        setStatus("Session expired. Please log in again.", true);
        return false;
      }
      auth = newAuth;
      res  = await run(auth);
    }

    if (!res.ok) {
      console.error("saveVoice HTTP error", res.status, await res.text());
      setStatus("Could not save voice. Try again.", true);
      return false;
    }

    setStatus("Voice saved. This will be used for new calls.");
    setTimeout(() => setStatus(""), 1800);
    currentVoiceId = voiceId;
    markSelected(voiceId);
    return true;
  }

  // 5) Audio preview logic
  let currentPreviewBtn = null;

  function stopPreview() {
    if (!audioEl) return;
    audioEl.pause();
    audioEl.currentTime = 0;
    if (currentPreviewBtn) {
      currentPreviewBtn.classList.remove("playing");
      currentPreviewBtn = null;
    }
  }

  async function handlePreviewClick(btn) {
    if (!audioEl) return;

    const url = btn.dataset.previewUrl;
    if (!url) return;

    // Toggle if same button
    if (currentPreviewBtn === btn && !audioEl.paused) {
      stopPreview();
      return;
    }

    // Switch to new preview
    stopPreview();
    currentPreviewBtn = btn;
    currentPreviewBtn.classList.add("playing");

    try {
      audioEl.src = url;
      await audioEl.play();
    } catch (err) {
      console.error("Preview play error:", err);
      setStatus("Could not play preview.", true);
      stopPreview();
    }
  }

  // Click delegation for preview + select
  grid.addEventListener("click", (event) => {
    const previewBtn = event.target.closest("[data-role='preview-voice']");
    const selectBtn  = event.target.closest("[data-role='select-voice']");

    if (previewBtn) {
      event.preventDefault();
      handlePreviewClick(previewBtn);
      return;
    }

    if (selectBtn) {
      event.preventDefault();

      // If assistant is not deployed, block and show hint
      if (selectBtn.classList.contains("disabled")) {
        setStatus("Deploy an assistant first.", true);
        setTimeout(() => setStatus(""), 1800);
        return;
      }

      const voiceId = selectBtn.dataset.voiceId;
      if (voiceId) {
        saveVoice(voiceId);
      }
    }
  });

  // Stop audio if user leaves the Voices tab
  window.addEventListener("hashchange", () => {
    const hash = (location.hash || "").replace("#", "");
    if (hash !== "voices") {
      stopPreview();
    }
  });

  // Init sequence
  await loadCurrentVoice();  // sets currentVoiceId + assistantIsDeployed
  renderVoices();
  setStatus("");
};

