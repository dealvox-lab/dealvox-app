// /assets/js/account-voices.js

// Static catalog generated from your CSV
const VOICES = [
  {
    "id": "retell-wavenet-Bella",
    "name": "Bella",
    "accent": "American",
    "gender": "female",
    "age": "Young",
    "avatar": "https://retell-utils-public.s3.us-west-2.amazonaws.com/bella.png",
    "preview": "https://retell-utils-public.s3.us-west-2.amazonaws.com/Bella.mp3",
    "provider": "google"
  },
  {
    "id": "retell-wavenet-Nathan",
    "name": "Nathan",
    "accent": "American",
    "gender": "male",
    "age": "Young",
    "avatar": "https://retell-utils-public.s3.us-west-2.amazonaws.com/nathan.png",
    "preview": "https://retell-utils-public.s3.us-west-2.amazonaws.com/Nathan.mp3",
    "provider": "google"
  },
  {
    "id": "retell-wavenet-Isabella",
    "name": "Isabella",
    "accent": "American",
    "gender": "female",
    "age": "Young",
    "avatar": "https://retell-utils-public.s3.us-west-2.amazonaws.com/isabella.png",
    "preview": "https://retell-utils-public.s3.us-west-2.amazonaws.com/Isabella.mp3",
    "provider": "google"
  },
  {
    "id": "retell-wavenet-Alexander",
    "name": "Alexander",
    "accent": "American",
    "gender": "male",
    "age": "Middle Aged",
    "avatar": "https://retell-utils-public.s3.us-west-2.amazonaws.com/alexander.png",
    "preview": "https://retell-utils-public.s3.us-west-2.amazonaws.com/Alexander.mp3",
    "provider": "google"
  },
  {
    "id": "retell-wavenet-Jack",
    "name": "Jack",
    "accent": "British",
    "gender": "male",
    "age": "Middle Aged",
    "avatar": "https://retell-utils-public.s3.us-west-2.amazonaws.com/jack.png",
    "preview": "https://retell-utils-public.s3.us-west-2.amazonaws.com/Jack.mp3",
    "provider": "google"
  },
  {
    "id": "retell-wavenet-Olivia",
    "name": "Olivia",
    "accent": "British",
    "gender": "female",
    "age": "Middle Aged",
    "avatar": "https://retell-utils-public.s3.us-west-2.amazonaws.com/olivia.png",
    "preview": "https://retell-utils-public.s3.us-west-2.amazonaws.com/Olivia.mp3",
    "provider": "google"
  },
  {
    "id": "retell-wavenet-Sofia",
    "name": "Sofia",
    "accent": "Spanish",
    "gender": "female",
    "age": "Young",
    "avatar": "https://retell-utils-public.s3.us-west-2.amazonaws.com/sofia.png",
    "preview": "https://retell-utils-public.s3.us-west-2.amazonaws.com/Sofia.mp3",
    "provider": "google"
  },
  {
    "id": "retell-wavenet-Daniel",
    "name": "Daniel",
    "accent": "Spanish",
    "gender": "male",
    "age": "Young",
    "avatar": "https://retell-utils-public.s3.us-west-2.amazonaws.com/daniel.png",
    "preview": "https://retell-utils-public.s3.us-west-2.amazonaws.com/Daniel.mp3",
    "provider": "google"
  },
  {
    "id": "retell-wavenet-Marie",
    "name": "Marie",
    "accent": "French",
    "gender": "female",
    "age": "Middle Aged",
    "avatar": "https://retell-utils-public.s3.us-west-2.amazonaws.com/marie.png",
    "preview": "https://retell-utils-public.s3.us-west-2.amazonaws.com/Marie.mp3",
    "provider": "google"
  },
  {
    "id": "retell-wavenet-Pierre",
    "name": "Pierre",
    "accent": "French",
    "gender": "male",
    "age": "Middle Aged",
    "avatar": "https://retell-utils-public.s3.us-west-2.amazonaws.com/pierre.png",
    "preview": "https://retell-utils-public.s3.us-west-2.amazonaws.com/Pierre.mp3",
    "provider": "google"
  },
  {
    "id": "retell-wavenet-Maria",
    "name": "Maria",
    "accent": "Portuguese",
    "gender": "female",
    "age": "Middle Aged",
    "avatar": "https://retell-utils-public.s3.us-west-2.amazonaws.com/maria.png",
    "preview": "https://retell-utils-public.s3.us-west-2.amazonaws.com/Maria.mp3",
    "provider": "google"
  },
  {
    "id": "retell-wavenet-Joao",
    "name": "João",
    "accent": "Portuguese",
    "gender": "male",
    "age": "Middle Aged",
    "avatar": "https://retell-utils-public.s3.us-west-2.amazonaws.com/joao.png",
    "preview": "https://retell-utils-public.s3.us-west-2.amazonaws.com/Joao.mp3",
    "provider": "google"
  },
  {
    "id": "retell-wavenet-Emma",
    "name": "Emma",
    "accent": "Australian",
    "gender": "female",
    "age": "Young",
    "avatar": "https://retell-utils-public.s3.us-west-2.amazonaws.com/emma.png",
    "preview": "https://retell-utils-public.s3.us-west-2.amazonaws.com/Emma.mp3",
    "provider": "google"
  },
  {
    "id": "retell-wavenet-Liam",
    "name": "Liam",
    "accent": "Australian",
    "gender": "male",
    "age": "Young",
    "avatar": "https://retell-utils-public.s3.us-west-2.amazonaws.com/liam.png",
    "preview": "https://retell-utils-public.s3.us-west-2.amazonaws.com/Liam.mp3",
    "provider": "google"
  },
  {
    "id": "retell-wavenet-Ava",
    "name": "Ava",
    "accent": "New Zealand",
    "gender": "female",
    "age": "Young",
    "avatar": "https://retell-utils-public.s3.us-west-2.amazonaws.com/ava.png",
    "preview": "https://retell-utils-public.s3.us-west-2.amazonaws.com/Ava.mp3",
    "provider": "google"
  },
  {
    "id": "retell-wavenet-Noah",
    "name": "Noah",
    "accent": "New Zealand",
    "gender": "male",
    "age": "Young",
    "avatar": "https://retell-utils-public.s3.us-west-2.amazonaws.com/noah.png",
    "preview": "https://retell-utils-public.s3.us-west-2.amazonaws.com/Noah.mp3",
    "provider": "google"
  },
  {
    "id": "retell-wavenet-Jiwoo",
    "name": "Jiwoo",
    "accent": "Korean",
    "gender": "female",
    "age": "Young",
    "avatar": "https://retell-utils-public.s3.us-west-2.amazonaws.com/jiwoo.png",
    "preview": "https://retell-utils-public.s3.us-west-2.amazonaws.com/Jiwoo.mp3",
    "provider": "google"
  },
  {
    "id": "retell-wavenet-Minjoon",
    "name": "Minjoon",
    "accent": "Korean",
    "gender": "male",
    "age": "Young",
    "avatar": "https://retell-utils-public.s3.us-west-2.amazonaws.com/minjoon.png",
    "preview": "https://retell-utils-public.s3.us-west-2.amazonaws.com/Minjoon.mp3",
    "provider": "google"
  },
  {
    "id": "retell-wavenet-Yuki",
    "name": "Yuki",
    "accent": "Japanese",
    "gender": "female",
    "age": "Young",
    "avatar": "https://retell-utils-public.s3.us-west-2.amazonaws.com/yuki.png",
    "preview": "https://retell-utils-public.s3.us-west-2.amazonaws.com/Yuki.mp3",
    "provider": "google"
  },
  {
    "id": "retell-wavenet-Haruto",
    "name": "Haruto",
    "accent": "Japanese",
    "gender": "male",
    "age": "Young",
    "avatar": "https://retell-utils-public.s3.us-west-2.amazonaws.com/haruto.png",
    "preview": "https://retell-utils-public.s3.us-west-2.amazonaws.com/Haruto.mp3",
    "provider": "google"
  },
  {
    "id": "retell-wavenet-Linda",
    "name": "Linda",
    "accent": "German",
    "gender": "female",
    "age": "Middle Aged",
    "avatar": "https://retell-utils-public.s3.us-west-2.amazonaws.com/linda.png",
    "preview": "https://retell-utils-public.s3.us-west-2.amazonaws.com/Linda.mp3",
    "provider": "google"
  },
  {
    "id": "retell-wavenet-Hans",
    "name": "Hans",
    "accent": "German",
    "gender": "male",
    "age": "Middle Aged",
    "avatar": "https://retell-utils-public.s3.us-west-2.amazonaws.com/hans.png",
    "preview": "https://retell-utils-public.s3.us-west-2.amazonaws.com/Hans.mp3",
    "provider": "google"
  },
  {
    "id": "11labs-Lily",
    "name": "Lily",
    "accent": "American",
    "gender": "female",
    "age": "Young",
    "avatar": "https://retell-utils-public.s3.us-west-2.amazonaws.com/lily.png",
    "preview": "https://retell-utils-public.s3.us-west-2.amazonaws.com/Lily.mp3",
    "provider": "elevenlabs"
  },
  {
    "id": "11labs-Ethan",
    "name": "Ethan",
    "accent": "American",
    "gender": "male",
    "age": "Young",
    "avatar": "https://retell-utils-public.s3.us-west-2.amazonaws.com/ethan.png",
    "preview": "https://retell-utils-public.s3.us-west-2.amazonaws.com/Ethan.mp3",
    "provider": "elevenlabs"
  },
  {
    "id": "11labs-Oliver",
    "name": "Oliver",
    "accent": "British",
    "gender": "male",
    "age": "Middle Aged",
    "avatar": "https://retell-utils-public.s3.us-west-2.amazonaws.com/oliver.png",
    "preview": "https://retell-utils-public.s3.us-west-2.amazonaws.com/Oliver.mp3",
    "provider": "elevenlabs"
  },
  {
    "id": "11labs-Amelia",
    "name": "Amelia",
    "accent": "British",
    "gender": "female",
    "age": "Middle Aged",
    "avatar": "https://retell-utils-public.s3.us-west-2.amazonaws.com/amelia.png",
    "preview": "https://retell-utils-public.s3.us-west-2.amazonaws.com/Amelia.mp3",
    "provider": "elevenlabs"
  },
  {
    "id": "11labs-Santiago",
    "name": "Santiago",
    "accent": "Spanish",
    "gender": "male",
    "age": "Young",
    "avatar": "https://retell-utils-public.s3.us-west-2.amazonaws.com/santiago.png",
    "preview": "https://retell-utils-public.s3.us-west-2.amazonaws.com/Santiago.mp3",
    "provider": "elevenlabs"
  },
  {
    "id": "11labs-Valentina",
    "name": "Valentina",
    "accent": "Spanish",
    "gender": "female",
    "age": "Young",
    "avatar": "https://retell-utils-public.s3.us-west-2.amazonaws.com/valentina.png",
    "preview": "https://retell-utils-public.s3.us-west-2.amazonaws.com/Valentina.mp3",
    "provider": "elevenlabs"
  },
  {
    "id": "11labs-Chloe",
    "name": "Chloe",
    "accent": "French",
    "gender": "female",
    "age": "Young",
    "avatar": "https://retell-utils-public.s3.us-west-2.amazonaws.com/chloe.png",
    "preview": "https://retell-utils-public.s3.us-west-2.amazonaws.com/Chloe.mp3",
    "provider": "elevenlabs"
  },
  {
    "id": "11labs-Louis",
    "name": "Louis",
    "accent": "French",
    "gender": "male",
    "age": "Young",
    "avatar": "https://retell-utils-public.s3.us-west-2.amazonaws.com/louis.png",
    "preview": "https://retell-utils-public.s3.us-west-2.amazonaws.com/Louis.mp3",
    "provider": "elevenlabs"
  },
  {
    "id": "11labs-Kathrine",
    "name": "Kathrine",
    "accent": "American",
    "gender": "female",
    "age": "Middle Aged",
    "avatar": "https://retell-utils-public.s3.us-west-2.amazonaws.com/kathrine.png",
    "preview": "https://retell-utils-public.s3.us-west-2.amazonaws.com/Kathrine.mp3",
    "provider": "elevenlabs"
  },
  {
    "id": "11labs-Andrew",
    "name": "Andrew",
    "accent": "American",
    "gender": "male",
    "age": "Middle Aged",
    "avatar": "https://retell-utils-public.s3.us-west-2.amazonaws.com/andrew.png",
    "preview": "https://retell-utils-public.s3.us-west-2.amazonaws.com/Andrew.mp3",
    "provider": "elevenlabs"
  }
];

// ----------------------------------------------------
// Voices tab logic (uses helpers from account.js)
// ----------------------------------------------------

window.initVoicesView = async function initVoicesView() {
  const grid     = document.getElementById("voicesGrid");
  const statusEl = document.getElementById("voicesStatus");
  const audioEl  = document.getElementById("voicePreviewAudio");

  if (!grid) return;

  grid.innerHTML = "";
  if (statusEl) statusEl.textContent = "Loading voices…";

  // 1) Auth info from existing helpers
  let auth;
  try {
    auth = await getAuthInfo();
  } catch (err) {
    console.error("getAuthInfo failed (voices):", err);
    if (statusEl) statusEl.textContent = "Unable to load voices. Please reload.";
    return;
  }

  if (!auth.user || !auth.accessToken) {
    if (statusEl) statusEl.textContent = "Session expired. Please log in again.";
    return;
  }

  const userId = auth.user.id;
  const baseUrl = `${window.SUPABASE_URL.replace(/\/+$/, "")}/rest/v1/assistants`;

  function setStatus(msg, isError = false) {
    if (!statusEl) return;
    statusEl.textContent = msg || "";
    statusEl.classList.toggle("error", !!isError);
  }

  // 2) Load current voice from assistants.agent_voice
  let currentVoiceId = null;

  async function loadCurrentVoice() {
    const params = new URLSearchParams();
    params.set("select", "agent_voice");
    params.set("user_id", `eq.${userId}`);
    params.set("limit", "1");

    async function run(currentAuth) {
      return fetch(`${baseUrl}?${params.toString()}`, {
        headers: supabaseHeaders(currentAuth.accessToken),
      });
    }

    let res = await run(auth);
    if (res.status === 401) {
      const newAuth = await handleJwt401(res, "load voice");
      if (!newAuth) {
        setStatus("Session expired. Please log in again.", true);
        return;
      }
      auth = newAuth;
      res = await run(auth);
    }

    if (!res.ok) {
      console.warn("loadCurrentVoice HTTP error", res.status, await res.text());
      return;
    }

    const rows = await res.json();
    if (rows && rows[0] && rows[0].agent_voice) {
      currentVoiceId = rows[0].agent_voice;
    }
  }

  // 3) Render voices grid
  function renderVoices() {
    grid.innerHTML = "";
    VOICES.forEach((voice) => {
      const card = document.createElement("div");
      card.className = "voice-card";
      card.dataset.voiceId = voice.id;

      if (currentVoiceId && voice.id === currentVoiceId) {
        card.classList.add("selected");
      }

      card.innerHTML = `
        <div class="voice-avatar-wrapper">
          <img class="voice-avatar" src="${voice.avatar}" alt="${voice.name}" loading="lazy" />
        </div>
        <div class="voice-body">
          <h3 class="voice-name">${voice.name}</h3>
          <p class="voice-meta">
            ${voice.gender ? voice.gender : ""}${
              voice.gender && voice.accent ? " · " : ""
            }${voice.accent ? voice.accent : ""}${
              (voice.gender || voice.accent) && voice.age ? " · " : ""
            }${voice.age ? voice.age : ""}
          </p>
          <div class="voice-actions">
            <button
              type="button"
              class="btn-secondary small voice-preview-btn"
              data-role="preview-voice"
              data-preview-url="${voice.preview}"
              data-voice-id="${voice.id}"
            >
              ▶ Preview
            </button>
            <button
              type="button"
              class="btn-primary small voice-select-btn"
              data-role="select-voice"
              data-voice-id="${voice.id}"
            >
              Select this voice
            </button>
          </div>
        </div>
      `;
      grid.appendChild(card);
    });
  }

  function markSelected(voiceId) {
    const cards = grid.querySelectorAll(".voice-card");
    cards.forEach((card) => {
      card.classList.toggle("selected", card.dataset.voiceId === voiceId);
    });
  }

  // 4) Save selected voice into assistants.agent_voice
  async function saveVoice(voiceId) {
    setStatus("Saving voice…");

    const payload = {
      user_id: userId,
      agent_voice: voiceId,
    };

    async function run(currentAuth) {
      return fetch(baseUrl, {
        method: "POST",
        headers: {
          ...supabaseHeaders(currentAuth.accessToken),
          Prefer: "return=minimal, resolution=merge-duplicates",
        },
        body: JSON.stringify(payload),
      });
    }

    let res = await run(auth);
    if (res.status === 401) {
      const newAuth = await handleJwt401(res, "save voice");
      if (!newAuth) {
        setStatus("Session expired. Please log in again.", true);
        return false;
      }
      auth = newAuth;
      res = await run(auth);
    }

    if (!res.ok) {
      console.error("saveVoice HTTP error", res.status, await res.text());
      setStatus("Could not save voice. Try again.", true);
      return false;
    }

    setStatus("Voice saved. This will be used for new calls.");
    setTimeout(() => setStatus(""), 1800);
    currentVoiceId = voiceId;
    markSelected(voiceId);
    return true;
  }

  // 5) Audio preview logic
  let currentPreviewBtn = null;

  function stopPreview() {
    if (!audioEl) return;
    audioEl.pause();
    audioEl.currentTime = 0;
    if (currentPreviewBtn) {
      currentPreviewBtn.classList.remove("playing");
      currentPreviewBtn = null;
    }
  }

  async function handlePreviewClick(btn) {
    if (!audioEl) return;

    const url = btn.dataset.previewUrl;
    if (!url) return;

    // Toggle if same button
    if (currentPreviewBtn === btn && !audioEl.paused) {
      stopPreview();
      return;
    }

    // Switch to new preview
    stopPreview();
    currentPreviewBtn = btn;
    currentPreviewBtn.classList.add("playing");

    try {
      audioEl.src = url;
      await audioEl.play();
    } catch (err) {
      console.error("Preview play error:", err);
      setStatus("Could not play preview.", true);
      stopPreview();
    }
  }

  // Click delegation for preview + select
  grid.addEventListener("click", (event) => {
    const previewBtn = event.target.closest("[data-role='preview-voice']");
    const selectBtn  = event.target.closest("[data-role='select-voice']");

    if (previewBtn) {
      event.preventDefault();
      handlePreviewClick(previewBtn);
      return;
    }

    if (selectBtn) {
      event.preventDefault();
      const voiceId = selectBtn.dataset.voiceId;
      if (voiceId) {
        saveVoice(voiceId);
      }
    }
  });

  // Stop audio if user leaves the Voices tab
  window.addEventListener("hashchange", () => {
    const hash = (location.hash || "").replace("#", "");
    if (hash !== "voices") {
      stopPreview();
    }
  });

  await loadCurrentVoice();
  renderVoices();
  setStatus("");
};
