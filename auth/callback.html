<script type="module">
  import { createClient } from "https://esm.sh/@supabase/supabase-js@2";

  // Provide these as globals or via Jekyll variables
  const SUPABASE_URL = window.SUPABASE_URL || "{{ site.supabase_url }}";
  const SUPABASE_ANON_KEY = window.SUPABASE_ANON_KEY || "{{ site.supabase_anon }}";

  if (!/^https?:\/\//.test(SUPABASE_URL)) {
    console.error("Missing/invalid SUPABASE_URL:", SUPABASE_URL);
    alert("Auth configuration error. Please contact support.");
    throw new Error("Invalid SUPABASE_URL");
  }

  const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY, {
    auth: { persistSession: false, flowType: "implicit" } // implicit is fine even if code path is used
  });

  async function setHttpOnlyCookies(access_token, refresh_token) {
    const resp = await fetch("/set-session", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      credentials: "include",
      body: JSON.stringify({ access_token, refresh_token })
    });
    if (!resp.ok) {
      const t = await resp.text().catch(() => "");
      throw new Error("Failed to set session cookies: " + t);
    }
  }

  (async () => {
    try {
      const qs   = new URLSearchParams(location.search);
      const hash = new URLSearchParams(location.hash.replace(/^#/, ""));

      // Accept ALL variants:
      const code_qs           = qs.get("code");                // PKCE
      let access_qs           = qs.get("access_token");        // implicit (query)
      let refresh_qs          = qs.get("refresh_token");
      let access_hash         = hash.get("access_token");      // implicit (hash)
      let refresh_hash        = hash.get("refresh_token");

      let access_token  = access_qs || access_hash;
      let refresh_token = refresh_qs || refresh_hash;

      if (code_qs) {
        // PKCE path
        const { data, error } = await supabase.auth.exchangeCodeForSession(location.href);
        if (error) throw error;
        access_token  = data.session?.access_token;
        refresh_token = data.session?.refresh_token;
      } else if (access_token) {
        // Implicit path (hash OR query)
        const { data, error } = await supabase.auth.setSession({ access_token, refresh_token });
        if (error) throw error;
        access_token  = data.session?.access_token || access_token;
        refresh_token = data.session?.refresh_token || refresh_token;
      } else {
        throw new Error("No code or tokens found in callback URL");
      }

      if (!access_token) throw new Error("No access token after auth");

      await setHttpOnlyCookies(access_token, refresh_token);

      const params = new URLSearchParams(location.search);
      const redirect = params.get("redirect") || "/account";
      location.replace(redirect);
    } catch (e) {
      console.error("Callback error:", e);
      alert("Sign-in failed. Please sign in again.");
      location.replace("/login");
    }
  })();
</script>
